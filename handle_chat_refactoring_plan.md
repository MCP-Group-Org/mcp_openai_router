# Описание задачи

Необходимо поэтапно рефакторить текущий обработчик `handle_chat`, чтобы снизить сложность, разделить ответственность между отдельными компонентами (адаптер клиента OpenAI, сервис опроса, обработчик инструментов) и ввести явные структуры данных для результатов, сохранив совместимость с существующей логикой и тестами.

## Предлагаемый подход (MVP → расширение)

1. Зафиксировать текущее поведение: собрать примеры входов/выходов, убедиться, что тесты отражают ключевые сценарии.
2. Ввести минимальный `OpenAIClientAdapter` и заменить прямое использование клиента в `handle_chat` без изменения остальных частей.
3. Вынести опрос ответа в `ResponsePoller`, подключить его к обработчику и удостовериться, что интерфейс совместим.
4. Создать первичную версию `ThinkToolProcessor`, делегирующую обработку инструментов, но начинающую с простой прокси-реализации.
5. Добавить `dataclass`-модели результатов и адаптировать основной поток обработки к ним.
6. Последовательно усиливать тесты, покрывая новые компоненты и общий сценарий `handle_chat`.
7. Провести дополнительные улучшения (асинхронность, расширенная обработка ошибок) только после стабилизации базовой версии.

## Наблюдения о текущем состоянии

- `_handle_chat` в `app/main.py` (~250 строк) совмещает валидацию, обращение к OpenAI, поллинг, обработку think и формирование итогового ответа.
- Основные интеграционные тесты (`tests/test_mcp_router.py`) проверяют: базовый ответ с toolCalls и сценарий с локальным think (follow-up + metadata).
- Поллинг реализован через вложенную функцию `_poll_response`, использующую `POLL_SEM`, `MAX_POLLS`, `POLL_DELAY`.
- Вспомогательные функции `_create_openai_client`, `_maybe_model_dump` уже выделены для monkeypatch.
- Логика think использует `_handle_think` напрямую; остальные незнакомые инструменты аккумулируются в `remaining_tool_calls`.

## Чеклист контрольных точек

- [x] Анализ исходного обработчика, фиксация текущих сценариев и поведения.
- [x] Добавление/обновление тестов, отражающих базовую функциональность до рефакторинга.
- [x] Внедрение `OpenAIClientAdapter`, прогон тестов.
- [x] Введение `ResponsePoller`, прогон тестов и локальный анализ логов.
- [x] Интеграция `ThinkToolProcessor` в качестве прокси, подтверждение отсутствия регрессий.
- [ ] Перевод результатов на `dataclass`-структуры, прогон тестов.
- [ ] Расширение тестового покрытия и финальная проверка.
