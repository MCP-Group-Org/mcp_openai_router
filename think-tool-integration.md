# План интеграции think-tool в mcp-openai-router

## Цели

- Дать сервису `mcp-openai-router` возможность фиксировать промежуточные рассуждения и диагностические данные с помощью удалённого инструмента `think` из `mcp_think_tool`.
- Сохранить совместимость с текущим протоколом MCP и потоками `tools/list`/`tools/call`, а также оставить базовую функциональность без обязательной зависимости от think-tool.

## Предпосылки и ограничения

- `mcp-openai-router` уже реализует MCP-сессию, выдаёт список инструментов и проксирует вызовы в OpenAI (через `chat`).
- Инструмент `think` предоставляет HTTP-интерфейс MCP поверх FastMCP; требуется стабильная точка доступа (адрес/порт) и, при необходимости, ключи телеметрии.
- В текущем коде хэндлеры синхронные; сетевые вызовы нужно либо делать синхронно (через `httpx.Client`), либо перевести обработку на `async` с использованием `anyio`/`httpx.AsyncClient`.
- CI должен оставаться изолированным от внешних сетей: для тестов потребуется мок или фейковый клиент think-tool.

## Этапы интеграции

- [ ] **Реализация обёртки для think-tool**
  - В `mcp-openai-router` добавить клиент think-tool (модуль наподобие `app/think_client.py`), который держит MCP-сессию с внешним сервером: `initialize`, кеширование `sessionId`, вызов `tools/call` с именем `think`.
  - Предусмотреть конфиг через переменные окружения (`THINK_TOOL_URL`, таймауты), graceful-fallback при недоступности сервиса и интеграцию с имеющейся телеметрией.

- [ ] **Интеграция инструмента в registry**
  - Расширить `TOOLS` и `TOOL_HANDLERS` новой записью `think`, описать схему аргументов (`thought`, `parent_trace_id`), делегировать вызов клиенту.
  - Убедиться, что `tools/list` возвращает новый инструмент, а `tools/call` корректно проксирует ответы think-tool.

- [ ] **Экспонирование инструмента модели**
  - Обновить системные инструкции или документацию, чтобы модель знала о доступном инструменте `think` и могла использовать его по своему усмотрению.
  - Дополнительный «обязательный» режим (авто-вызовы из `chat`) отложить до отдельного решения — текущая реализация ограничивается базовым сценарием без навязанного вызова.

- [ ] **Интеграционные проверки (ИФТ)**
  - Расширить `tests/test_mcp_router.py` моками клиента: проверка `tools/list`, `tools/call(think)` и сценариев деградации.
  - При необходимости провести ручную проверку с реальным сервером think-tool (docker-compose), зафиксировать шаги и убедиться, что основной функционал сервиса не страдает.

## Дополнительно

- Синхронизировать README и `.env` с новыми настройками.
- В логах отделять ошибки think-tool от ошибок OpenAI, чтобы упростить эксплуатацию.
- При деградации think-tool обеспечивать устойчивый fallback, чтобы `chat` оставался рабочим.

## Следующие шаги

- Подтвердить желаемый сценарий (только явный MCP-инструмент или авто-инъекция в `chat`).
- После согласования оценить трудозатраты и перейти к реализации по этапам выше.
